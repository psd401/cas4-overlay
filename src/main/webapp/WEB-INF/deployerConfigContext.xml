<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:p="http://www.springframework.org/schema/p"
       xmlns:c="http://www.springframework.org/schema/c"
       xmlns:tx="http://www.springframework.org/schema/tx"
       xmlns:util="http://www.springframework.org/schema/util"
       xmlns:sec="http://www.springframework.org/schema/security"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.2.xsd
       http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-3.2.xsd
       http://www.springframework.org/schema/security http://www.springframework.org/schema/security/spring-security-3.2.xsd
       http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util.xsd">
    <!--
     | Change principalIdAttribute to use another directory attribute,
     | e.g. userPrincipalName, for the NetID
     -->
  <bean id="ldapAuthenticationHandler"
        class="org.jasig.cas.authentication.LdapAuthenticationHandler"
        p:principalIdAttribute="sAMAccountName"
        c:authenticator-ref="authenticator">
      <property name="principalAttributeMap">
          <map>
              <!--
                 | This map provides a simple attribute resolution mechanism.
                 | Keys are LDAP attribute names, values are CAS attribute names.
                 | Use this facility instead of a PrincipalResolver if LDAP is
                 | the only attribute source.
                 -->
              <entry key="displayName" value="displayName" />
              <entry key="mail" value="mail" />
              <entry key="memberOf" value="memberOf" />
          </map>
      </property>
  </bean>

  <bean id="authenticator" class="org.ldaptive.auth.Authenticator"
        c:resolver-ref="dnResolver"
        c:handler-ref="authHandler"
        p:entryResolver-ref="entryResolver" />

  <!-- Active Directory UPN format. -->
  <bean id="dnResolver"
        class="org.ldaptive.auth.FormatDnResolver"
        c:format="%s@${ldap.domain}" />

  <bean id="authHandler" class="org.ldaptive.auth.PooledBindAuthenticationHandler"
        p:connectionFactory-ref="pooledLdapConnectionFactory" />

  <bean id="pooledLdapConnectionFactory"
        class="org.ldaptive.pool.PooledConnectionFactory"
        p:connectionPool-ref="connectionPool" />

  <bean id="connectionPool"
        class="org.ldaptive.pool.BlockingConnectionPool"
        init-method="initialize"
        p:poolConfig-ref="ldapPoolConfig"
        p:blockWaitTime="${ldap.pool.blockWaitTime}"
        p:validator-ref="searchValidator"
        p:pruneStrategy-ref="pruneStrategy"
        p:connectionFactory-ref="connectionFactory" />

  <bean id="ldapPoolConfig" class="org.ldaptive.pool.PoolConfig"
        p:minPoolSize="${ldap.pool.minSize}"
        p:maxPoolSize="${ldap.pool.maxSize}"
        p:validateOnCheckOut="${ldap.pool.validateOnCheckout}"
        p:validatePeriodically="${ldap.pool.validatePeriodically}"
        p:validatePeriod="${ldap.pool.validatePeriod}" />

  <bean id="connectionFactory" class="org.ldaptive.DefaultConnectionFactory"
        p:connectionConfig-ref="connectionConfig" />

  <bean id="connectionConfig" class="org.ldaptive.ConnectionConfig"
        p:ldapUrl="${ldap.url}"
        p:connectTimeout="${ldap.connectTimeout}"
        p:useStartTLS="${ldap.useStartTLS}"
        p:sslConfig-ref="sslConfig"/>

  <bean id="sslConfig" class="org.ldaptive.ssl.SslConfig">
      <property name="credentialConfig">
          <bean class="org.ldaptive.ssl.X509CredentialConfig"
                p:trustCertificates="${ldap.trustedCert}" />
      </property>
  </bean>

  <bean id="pruneStrategy" class="org.ldaptive.pool.IdlePruneStrategy"
        p:prunePeriod="${ldap.pool.prunePeriod}"
        p:idleTime="${ldap.pool.idleTime}" />

  <bean id="searchValidator" class="org.ldaptive.pool.SearchValidator" />

  <bean id="entryResolver"
        class="org.jasig.cas.authentication.support.UpnSearchEntryResolver"
        p:baseDn="${ldap.baseDn}" />

</beans>